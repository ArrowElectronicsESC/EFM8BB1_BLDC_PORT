C51 COMPILER V9.53.0.0   ADC                                                               01/28/2020 16:32:32 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE ADC
OBJECT MODULE PLACED IN .\src\adc.OBJ
COMPILER INVOKED BY: c:\SiliconLabs\SimplicityStudio\v4\developer\toolchains\keil_8051\9.53\BIN\C51.exe C:\Users\A92862\
                    -SimplicityStudio\v4_workspace\EFM8BB1_BLDC_PORT\src\adc.c OMF2 SMALL DEBUG OBJECTEXTEND ROM(LARGE) WARNINGLEVEL(2) FLOAT
                    -FUZZY(3) OPTIMIZE(8,SPEED) INTVECTOR(0X0000) INTPROMOTE INCDIR(C:\Users\A92862\SimplicityStudio\v4_workspace\EFM8BB1_BLD
                    -C_PORT\inc;C:\Users\A92862\SimplicityStudio\v4_workspace\EFM8BB1_BLDC_PORT\inc\config;C:/SiliconLabs/SimplicityStudio/v4
                    -/developer/sdks/8051/v4.1.7//kits/common/drivers/efm8_retargetserial;C:/SiliconLabs/SimplicityStudio/v4/developer/sdks/8
                    -051/v4.1.7//Lib/efm8_assert;C:/SiliconLabs/SimplicityStudio/v4/developer/sdks/8051/v4.1.7//kits/common/bsp;C:/SiliconLab
                    -s/SimplicityStudio/v4/developer/sdks/8051/v4.1.7//kits/EFM8BB1_LCK/config;C:/SiliconLabs/SimplicityStudio/v4/developer/s
                    -dks/8051/v4.1.7//Device/shared/si8051Base;C:/SiliconLabs/SimplicityStudio/v4/developer/sdks/8051/v4.1.7//Device/EFM8BB1/
                    -inc;C:/SiliconLabs/SimplicityStudio/v4/developer/sdks/8051/v4.1.7//Device/EFM8BB1/peripheral_driver/inc) PRINT(.\src\adc
                    -.lst) COND PAGEWIDTH(120) PAGELENGTH(65) OBJECT(.\src\adc.OBJ)

line level    source

   1          /*
   2           * adc.c
   3           *
   4           *  Created on: Jan 16, 2020
   5           *      Author: a92862
   6           */
   7          
   8          //-----------------------------------------------------------------------------
   9          // Includes
  10          //-----------------------------------------------------------------------------
  11          #include "bldcdk.h"
  12          
  13          //-----------------------------------------------------------------------------
  14          // Global Constants
  15          //-----------------------------------------------------------------------------
  16          
  17          
  18          //-----------------------------------------------------------------------------
  19          // Function Prototypes
  20          //-----------------------------------------------------------------------------
  21          void ADC_initialize_adc(void);
  22          
  23          //-----------------------------------------------------------------------------
  24          // Global Variables
  25          //-----------------------------------------------------------------------------
  26          // ADC mux table for POT(speed input), VMDC, Current
  27          const U8 code adc_mux[NUM_ADC_POINTS] = {
  28          #ifdef FEATURE_OVERCURRENT
  29              IMEAS_ADCMX,
  30          #endif
  31          #ifdef FEATURE_MEAS_VMDC
  32              VMDC_ADCMX,
  33          #endif
  34          #ifdef FEATURE_MEAS_POT
  35              POT_ADCMX
  36          #endif
  37          };
  38          
  39          static SEG_IDATA U8 adc_index;
  40          SEG_XDATA U16       adc_result[NUM_ADC_POINTS];
  41          SEG_DATA U8         adc_flags;
  42          
  43          //-----------------------------------------------------------------------------
  44          // ADC_initialize_adc
  45          //-----------------------------------------------------------------------------
  46          //
  47          // Return Value : None
C51 COMPILER V9.53.0.0   ADC                                                               01/28/2020 16:32:32 PAGE 2   

  48          // Parameters   : None
  49          //
  50          // Burst mode timing consists of the following segments for non-low-mode:
  51          // (A) Start Burst mode Preparation:
  52          //       7 HFO clocks
  53          // (B) Each SAR conversion consists of:
  54          //       1 HFO clock for MS Bit SAR preparation:
  55          //       4*ADTM SAR clocks before conversion
  56          //       11 SAR clocks for conversion
  57          //       1 HFO clock at end of SAR for LS bit latching
  58          //     Sub-Total = number of accumulation x (sum of above)
  59          // (C) Burst mode tracking time BETWEEN SAR conversion:
  60          //        66-ADTK HFO clocks
  61          //     Sub-Total = (number of accumulation - 1) x (sum of above)
  62          // (D) Synchronization: 3 SYSCLK to transfer status into ADINT bit.
  63          //
  64          // ADC Timing is synchronized with pwm signal to calculate average current.
  65          //
  66          // We use ADSC = 4 (i.e. SARCLK = 5 HFOCLKS)
  67          //        ADTM = 0
  68          //        ADTK = 59
  69          //        ADRPT = 5 (64x accumulation)
  70          // Ignoring (D), the total time for 64 accumulation:
  71          //  7 + ( 1 + ((11 + 4*0) * 5) + 1 ) * 64 + (66 - 59) * (64 - 1) = 4096 HFO clocks
  72          // As the PWM frequency is 10-bit, and 1 SYSCLK = 1 HFO clock, the ADC averaging
  73          //  occurs over exactly 4 PWM cycles
  74          //-----------------------------------------------------------------------------
  75          void ADC_initialize_adc(void)
  76          {
  77   1              // ADC Ref : Internal 1.65V
  78   1              REF0CN = (0x03<<3);
  79   1      
  80   1              // 64 accumulation(16bit effectively) and right justified,shifted right
  81   1              // by 2bit. The adc result has 14bit resolution.
  82   1              ADC0AC = 0x95;
  83   1      
  84   1              // SAR clock = 24.5/(1+ADSC) = 4.9MHz
  85   1              // ADSC = 4, ADTM = 0, adc0 gain = 0.5
  86   1              ADC0CF = 0x20;
  87   1      
  88   1              // ADCMBE = 1,  Common mode buffer enable;
  89   1              ADC0CN1 = 0x01;
  90   1      
  91   1              // Burst mode track time = 7 HFO CLK: ADC0TK = 66 - 7 = 59
  92   1              ADC0TK = 59;
  93   1      
  94   1              // ADPWR = 8 SYSCLK
  95   1              ADC0PWR = 1;
  96   1      
  97   1              // Enable ADC, Start of conversion mode = AD0BUSY
  98   1              // Enable Burst mode (ADCMBE=1)
  99   1              ADC0CN0 = 0xC0;
 100   1      
 101   1          // initiate 1st conversion of adc.
 102   1          ADC_CLEAR_FLAG();
 103   1          adc_index = 0;
 104   1          ADC0MX = adc_mux[adc_index];
 105   1          ADC0CN0_ADBUSY = 1;
 106   1          adc_flags = 0;
 107   1      }
 108          
 109          //-----------------------------------------------------------------------------
 110          // ADC_task
C51 COMPILER V9.53.0.0   ADC                                                               01/28/2020 16:32:32 PAGE 3   

 111          //-----------------------------------------------------------------------------
 112          // Return Value : None
 113          // Parameters   : None
 114          //
 115          // Description  :
 116          //  AD0BUSY initiate conversion.
 117          //  Once conversion is done, adc_flags updated accordingly. The latest result
 118          //  can be found at the adc_result[] in the point of application level.
 119          //  User application should call this function regularly.
 120          //-----------------------------------------------------------------------------
 121          void ADC_task(void)
 122          {
 123   1          if(ADC0CN0_ADINT)
 124   1          {
 125   2              adc_result[adc_index] = ADC0;
 126   2              ADC_CLEAR_FLAG();
 127   2      
 128   2              adc_flags |= (1<<adc_index);
 129   2              adc_index++;
 130   2              if( adc_index >= NUM_ADC_POINTS)
 131   2              {
 132   3                  adc_index = 0;
 133   3              }
 134   2              ADC0MX = adc_mux[adc_index];
 135   2              // start conversion
 136   2              ADC_START();
 137   2          }
 138   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    103    ----
   CONSTANT SIZE    =      3    ----
   XDATA SIZE       =      6    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1    ----
   IDATA SIZE       =      1    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
